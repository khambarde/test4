{"triggers":[],"nodes":[{"uid":"cf16f0dd-b738-442d-97dc-66a9841bb886","commandName":"connect","packageName":"Database","disabled":false,"attributes":[{"name":"session","value":{"type":"STRING","string":"Default"}},{"name":"connectionMode","value":{"type":"STRING","string":"USER"}},{"name":"databaseProvider","value":{"type":"STRING","string":"SQLOLEDB.1"}},{"name":"server","value":{"type":"STRING","string":"NDS-AA-02"}},{"name":"database","value":{"type":"STRING","string":"HPU"}},{"name":"user","value":{"type":"STRING","string":"RPA"}},{"name":"auth","value":{"type":"STRING","string":"nds1@2020"}},{"name":"instance","value":{"type":"STRING","string":""}},{"name":"isUserDefinedDriver","value":{"type":"BOOLEAN","boolean":false}}]},{"uid":"53d550fe-8e40-4de1-877e-a26a1ca2a57b","commandName":"emailConnect","packageName":"Email","disabled":false,"attributes":[{"name":"session","value":{"type":"STRING","string":"EmailSession"}},{"name":"serverType","value":{"type":"STRING","string":"OUTLOOK"}}]},{"uid":"039b18c7-9f82-4c20-a8c8-c61e7757c28f","commandName":"loop.commands.start","packageName":"Loop","disabled":false,"children":[{"uid":"0829194f-9d4a-44bd-af5a-ff92f81289db","commandName":"store","packageName":"Database","disabled":false,"attributes":[{"name":"session","value":{"type":"STRING","string":"Default"}},{"name":"query","value":{"type":"STRING","string":"USP_InsertEmailLog"}},{"name":"entryList","value":{"type":"LIST","list":[{"type":"DICTIONARY","dictionary":[{"key":"inOrOutParamter","value":{"type":"STRING","string":"Input"}},{"key":"parametername","value":{"type":"STRING","string":""}},{"key":"parametervalue","value":{"type":"STRING","expression":"$UnReadMail{emailSubject}$"}},{"key":"outputParamType","value":{"type":"STRING","string":"VARCHAR"}}]},{"type":"DICTIONARY","dictionary":[{"key":"inOrOutParamter","value":{"type":"STRING","string":"Input"}},{"key":"parametername","value":{"type":"STRING","string":""}},{"key":"parametervalue","value":{"type":"STRING","expression":"$UnReadMail{emailMessage}$"}},{"key":"outputParamType","value":{"type":"STRING","string":"VARCHAR"}}]},{"type":"DICTIONARY","dictionary":[{"key":"inOrOutParamter","value":{"type":"STRING","string":"Input"}},{"key":"parametername","value":{"type":"STRING","string":""}},{"key":"parametervalue","value":{"type":"STRING","expression":"$UnReadMail{emailFrom}$"}},{"key":"outputParamType","value":{"type":"STRING","string":"VARCHAR"}}]}]}},{"name":"doExport","value":{"type":"BOOLEAN","boolean":false}}]},{"uid":"7c572e1e-6141-4623-bb2e-381537d8ef1b","commandName":"python.commands.openScript","packageName":"Python","disabled":false,"attributes":[{"name":"session","value":{"type":"STRING","string":"Default1"}},{"name":"scriptOption","value":{"type":"STRING","string":"SCRIPT"}},{"name":"script","value":{"type":"STRING","string":"# -*- coding: utf-8 -*-\n\"\"\"\nCreated on Wed Nov  4 11:33:27 2020\n\n@author: khambarde\n\"\"\"\n\n\n# -*- coding: utf-8 -*-\n\"\"\"\nCreated on Sat Oct 24 15:09:40 2020\n\n@author: dmohanty\n\"\"\"\nimport pandas as pd\nimport pyodbc \n\n\n\n\nconn_str = (\n    r'DRIVER={SQL Server};'\n    r'SERVER=NDS-AA-02;'\n    r'DATABASE=HPU;'\n    r'Trusted_Connection=no;'\n    r'UID=RPA;'\n    r'PWD=nds1@2020;'\n    r'autocommit=True'\n)\n\ndef ClassifySenderEmail():\n    #conhdr = pyodbc.connect(conn_str)\n    cnxn = pyodbc.connect(conn_str)\n    sqlExecSP=\"{call USP_GetMailsToBeClassifiedForClient }\"\n    dfMailListToBeClassified = pd.read_sql_query(sql=sqlExecSP, con=cnxn)\n    \n    for rowclientindex in dfMailListToBeClassified.index:\n        print(rowclientindex, dfMailListToBeClassified['ID'][rowclientindex],dfMailListToBeClassified['FROM_EMAIL_ADDRESS'][rowclientindex],dfMailListToBeClassified['SUBJECT'][rowclientindex])\n        inemailid=int(dfMailListToBeClassified['ID'][rowclientindex])\n        senderemailaddress=dfMailListToBeClassified['FROM_EMAIL_ADDRESS'][rowclientindex]\n        receivedmailsubjectbody=dfMailListToBeClassified['SUBJECT'][rowclientindex]+' '+dfMailListToBeClassified['MAIL_BODY'][rowclientindex]\n        #cnxn = pyodbc.connect(conn_str)\n        outputmsg=''\n        ismailclassified=False\n        classifiedclientid=0\n        classifiedclientname=''\n        sqlExecSP=\"{call USP_GetClientListFromIncomingEmailId (?)}\"\n        params = (senderemailaddress,)\n        dfClientIncomingEmails = pd.read_sql_query(sql=sqlExecSP, con=cnxn, params=params)\n        #print (dfClientIncomingEmails)\n        #print( len(dfClientIncomingEmails.index))\n        if(dfClientIncomingEmails.shape[0] > 0):\n            if(dfClientIncomingEmails.shape[0] > 1):\n                #cnxn = pyodbc.connect(conn_str)\n                sqlExecSP=\"{call USP_GetCrosswalkKeyListFromIncomingEmailId (?)}\"\n                params = (senderemailaddress,)\n                dfClientCrosswalkKeywords = pd.read_sql_query(sql=sqlExecSP, con=cnxn, params=params)\n                #print (dfClientIncomingEmails)\n                #print( len(dfClientCrosswalkKeywords.index))\n                formattedmailsubjectbody=receivedmailsubjectbody.upper().replace(\" \",\"\")\n                for rowindex in dfClientCrosswalkKeywords.index:\n                    #print(rowindex, dfClientCrosswalkKeywords['MAIL_KEY_WORD'][rowindex],dfClientCrosswalkKeywords['CLIENT_ID'][rowindex],dfClientCrosswalkKeywords['CLIENT_NAME'][rowindex])\n                    formattedkeyword=dfClientCrosswalkKeywords['MAIL_KEY_WORD'][rowindex]\n                    formattedkeyword=formattedkeyword.upper().replace(\" \",\"\")\n                    if formattedkeyword in formattedmailsubjectbody:\n                        outputmsg='2-Mail classiifed successfully'\n                        ismailclassified=True\n                        classifiedclientid= dfClientCrosswalkKeywords['CLIENT_ID'][rowindex]\n                        classifiedclientname=dfClientCrosswalkKeywords['CLIENT_NAME'][rowindex]\n                        break\n                if ismailclassified == False :\n                    outputmsg='4-Mail could not be classified. keyword is not matching'\n                \n            else:\n                outputmsg='1-Mail classiifed successfully'\n                ismailclassified=True\n                classifiedclientid= dfClientIncomingEmails['CLIENT_ID'][0]\n                classifiedclientname=dfClientIncomingEmails['CLIENT_NAME'][0]      \n        else:\n            outputmsg='3-Mail could not be classified. Sender email id s not found in database'\n        #cnxnnew = pyodbc.connect(conn_str)\n        cur = cnxn.cursor()\n        sqlExecSP=\"{call USP_UPDATEMAILCLASSIFICATIONCLIENTIDNew (?,?,?,?)}\"\n        cur.execute(sqlExecSP,int(inemailid),senderemailaddress,int(classifiedclientid),outputmsg)\n        cnxn.commit()\n        #return (OUT_OUTPUT_MSG,OUT_IS_MAIL_CLASSIFIED,OUT_CLASSIFIED_CLIENT_ID,OUT_CLASSIFIED_CLIENT_NAME)\n    cur.close()\n    cnxn.close()\n  \n    \n\n\nClassifySenderEmail()\n# print('Classification program processed successfully')\n"}},{"name":"version","value":{"type":"STRING","string":"3"}}]},{"uid":"0a7cfc11-d0f1-4ba8-8952-d033db5a7620","commandName":"python.commands.executeScript","packageName":"Python","disabled":false,"attributes":[{"name":"session","value":{"type":"STRING","string":"Default1"}}]},{"uid":"96a392cd-01f8-467c-9263-ed960a053f73","commandName":"loop.commands.start","packageName":"Loop","disabled":false,"children":[{"uid":"e47ce10e-e862-4d06-8c20-a009ec05ac2f","commandName":"if","packageName":"If","disabled":false,"children":[],"branches":[],"attributes":[{"name":"condition","attributes":[{"name":"variable","value":{"type":"NUMBER","expression":"$EMAIL_RECORD{CLIENTID}$"}},{"name":"operator","value":{"type":"STRING","string":"GT"}},{"name":"value","value":{"type":"NUMBER","number":"1"}}],"value":{"type":"CONDITIONAL","conditionalName":"numberVariable","packageName":"Number"}}]}],"attributes":[{"name":"loopType","value":{"type":"STRING","string":"ITERATOR"}},{"name":"iterator","returnTo":{"type":"VARIABLE","variableName":"EMAIL_RECORD"},"attributes":[{"name":"session","value":{"type":"STRING","string":"Default"}}],"value":{"type":"ITERATOR","iteratorName":"iterators.resultset","packageName":"Database"}}]}],"attributes":[{"name":"loopType","value":{"type":"STRING","string":"ITERATOR"}},{"name":"iterator","returnTo":{"type":"VARIABLE","variableName":"UnReadMail"},"attributes":[{"name":"sessionName","value":{"type":"STRING","string":"EmailSession"}},{"name":"readStatus","value":{"type":"STRING","string":"UNREAD"}},{"name":"folder","value":{"type":"STRING","string":"Inbox"}},{"name":"subject","value":{"type":"STRING","string":""}},{"name":"from","value":{"type":"STRING","string":""}},{"name":"messageFormat","value":{"type":"STRING","string":"HTML"}}],"value":{"type":"ITERATOR","iteratorName":"loop.iterators.email","packageName":"Email"}}]}],"variables":[{"name":"prompt-assignment","description":"A variable you can use for assignments","type":"STRING","subtype":"UNDEFINED","readOnly":false,"input":false,"output":false},{"name":"UnReadMail","description":"","type":"DICTIONARY","readOnly":false,"input":false,"output":false,"subtype":"STRING","defaultValue":{"type":"DICTIONARY","dictionary":[]}},{"name":"EMAIL_RECORD","description":"","type":"RECORD","readOnly":false,"input":false,"output":false,"subtype":"UNDEFINED","defaultValue":{"type":"RECORD","record":{"schema":[],"values":[]}}}],"breakpoints":[],"packages":[{"name":"Database","version":"2.1.0-20200913-060112"},{"name":"Email","version":"3.0.0-20200901-105426"},{"name":"If","version":"2.1.0-20200825-071156"},{"name":"Loop","version":"2.1.0-20200831-031540"},{"name":"Number","version":"2.1.0-20200831-031551"},{"name":"Python","version":"2.1.0-20200831-031850"}],"workItemTemplateName":null}